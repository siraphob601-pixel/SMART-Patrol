<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>SMART Patrol - Duplicate Checker Tool</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 2px solid #28a745; padding-bottom: 15px; margin-bottom: 20px; }
        .upload-box { border: 3px dashed #28a745; padding: 40px; text-align: center; border-radius: 10px; cursor: pointer; background: #f1fdf4; transition: 0.3s; }
        .upload-box:hover { background: #e2f7e8; border-color: #218838; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: center; }
        th { background-color: #28a745; color: white; }
        .count-high { color: #dc3545; font-weight: bold; font-size: 1.2em; }
        .btn-print { margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≤‡∏î‡∏ï‡∏£‡∏∞‡πÄ‡∏ß‡∏ô‡∏ã‡πâ‡∏≥</h2>
        <p>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ SMART PATROL (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A, M, N)</p>
    </div>

    <div class="upload-box" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <strong>üìÅ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</strong>
        <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á Encoding ‡πÄ‡∏≠‡∏á)</p>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
    </div>

    <div id="resultArea"></div>
    <button class="btn-print" id="printBtn" onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
</div>

<script>
document.getElementById('fileInput').addEventListener('change', handleFile);

function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    // ‡πÉ‡∏ä‡πâ TIS-620 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå SMART ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    reader.readAsText(file, "TIS-620"); 

    reader.onload = function(event) {
        processData(event.target.result);
    };
}

function processData(csvText) {
    const rows = csvText.split(/\r?\n/);
    const data = [];
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Index ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏∞‡∏ö‡∏∏
    const COL_A_ID = 0; // ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏™‡πâ‡∏ô
    const COL_M_X = 12; // ‡∏û‡∏¥‡∏Å‡∏±‡∏î X
    const COL_N_Y = 13; // ‡∏û‡∏¥‡∏Å‡∏±‡∏î Y

    // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Array
    for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].split(',');
        if (cells.length < 14) continue;

        const id = cells[COL_A_ID]?.trim();
        const x = cells[COL_M_X]?.trim();
        const y = cells[COL_N_Y]?.trim();

        if (id && x && y) {
            data.push({ id, xy: x + "|" + y });
        }
    }

    // 2. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏ã‡πâ‡∏≥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô (Logic ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠)
    const pairResults = {};

    for (let i = 0; i < data.length; i++) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û)
        for (let j = i + 1; j < Math.min(i + 500, data.length); j++) {
            if (data[i].xy === data[j].xy && data[i].id !== data[j].id) {
                const pairKey = [data[i].id, data[j].id].sort().join(" ‡πÅ‡∏•‡∏∞ ");
                pairResults[pairKey] = (pairResults[pairKey] || 0) + 1;
            }
        }
    }

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    displayTable(pairResults);
}

function displayTable(results) {
    const area = document.getElementById('resultArea');
    const btn = document.getElementById('printBtn');
    let html = '<table><tr><th>‡∏Ñ‡∏π‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏•‡∏≤‡∏î‡∏ï‡∏£‡∏∞‡πÄ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô (‡∏Ñ‡∏π‡πà)</th></tr>';
    let hasData = false;

    for (const [pair, count] of Object.entries(results)) {
        if (count >= 20) { // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 20 ‡∏Ñ‡∏π‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠
            html += `<tr><td>${pair}</td><td class="count-high">${count}</td></tr>`;
            hasData = true;
        }
    }

    if (!hasData) {
        html += '<tr><td colspan="2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå (20 ‡∏à‡∏∏‡∏î)</td></tr>';
        btn.style.display = 'none';
    } else {
        btn.style.display = 'block';
    }

    html += '</table>';
    area.innerHTML = html;
}
</script>

</body>
</html>