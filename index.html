<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>SMART Patrol Duplicate Checker - Optimized</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 3px solid #28a745; margin-bottom: 25px; padding-bottom: 10px; }
        .upload-area { border: 2px dashed #28a745; padding: 40px; text-align: center; cursor: pointer; background: #e9f7ef; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; vertical-align: top; }
        th { background-color: #28a745; color: white; text-align: center; }
        .count-cell { text-align: center; font-weight: bold; color: #d9534f; font-size: 1.2em; }
        .wp-list-area { font-size: 0.85em; color: #333; line-height: 1.6; word-break: break-all; }
        .wp-summary { display: block; margin-top: 8px; font-weight: bold; color: #0056b3; border-top: 1px solid #eee; padding-top: 5px; }
        .status-cell { text-align: center; font-weight: bold; color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ </h2>
        <p>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ã‡πâ‡∏≥ >= 20 ‡∏à‡∏∏‡∏î (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A, G, H, J, K)</p>
    </div>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <strong>üìÅ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .csv ‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° SMART</strong>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
    </div>

    <div id="resultArea"></div>
</div>

<script>
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.readAsText(file, "TIS-620"); 
    reader.onload = function(event) {
        const rows = event.target.result.split(/\r?\n/).map(row => row.split(','));
        processSmartData(rows);
    };
});

function processSmartData(rows) {
    if (rows.length < 2) return;

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô A=0, G=6, H=7, J=9, K=10
    let data = rows.slice(1).filter(r => r.length > 10).map(r => ({
        patrolId: r[0]?.trim(),
        waypointId: r[6]?.trim(),
        date: r[7]?.trim(),
        xy: (r[9]?.trim() || "") + (r[10]?.trim() || "")
    }));

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° XY ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ 9
    data.sort((a, b) => a.xy.localeCompare(b.xy) || a.date.localeCompare(b.date));

    let pairResults = {};

    for (let i = 0; i < data.length; i++) {
        let current = data[i];
        for (let j = i + 1; j < data.length; j++) {
            let next = data[j];
            if (current.xy !== next.xy) break;

            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤ 10 ‡πÅ‡∏•‡∏∞ 12
            if (current.patrolId !== next.patrolId && current.date !== next.date) {
                let pairNames = [current.patrolId, next.patrolId].sort();
                let pairKey = pairNames.join(", ");
                
                if (!pairResults[pairKey]) {
                    pairResults[pairKey] = { count: 0, waypoints: [] };
                }
                
                pairResults[pairKey].count += 1;
                if (current.waypointId) pairResults[pairKey].waypoints.push(current.waypointId);
                if (next.waypointId) pairResults[pairKey].waypoints.push(next.waypointId);
            }
        }
    }

    renderTable(pairResults);
}

function renderTable(results) {
    const area = document.getElementById('resultArea');
    let html = '<table><thead><tr>' +
               '<th>‡∏Ñ‡∏π‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏•‡∏≤‡∏î‡∏ï‡∏£‡∏∞‡πÄ‡∏ß‡∏ô (‡πÄ‡∏™‡πâ‡∏ô‡∏ã‡πâ‡∏≥)</th>' +
               '<th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥ (count)</th>' +
               '<th>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ß‡∏¢‡πå‡∏û‡∏≠‡∏¢‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö)</th>' +
               '<th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>' +
               '</tr></thead><tbody>';

    let foundData = false;
    for (const [pair, info] of Object.entries(results)) {
        if (info.count >= 20) {
            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ß‡∏¢‡πå‡∏û‡∏≠‡∏¢‡∏ó‡πå‡∏ã‡πâ‡∏≥‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å
            const uniqueSortedWp = [...new Set(info.waypoints)]
                .map(Number)
                .sort((a, b) => a - b);
            
            const wpList = uniqueSortedWp.join(", ");
            const wpTotal = uniqueSortedWp.length;

            html += `<tr>
                <td><b>${pair}</b></td>
                <td class="count-cell">${info.count}</td>
                <td class="wp-list-area">
                    ${wpList}
                    <span class="wp-summary">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${wpTotal} ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ß‡∏¢‡πå‡∏û‡∏≠‡∏¢‡∏ó‡πå</span>
            </tr>`;
            foundData = true;
        }
    }

    if (!foundData) {
        html += '<tr><td colspan="4" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏à‡∏∏‡∏î</td></tr>';
    }

    html += '</tbody></table>';
    area.innerHTML = html;
}
</script>

</body>
</html>

