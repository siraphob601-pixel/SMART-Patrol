<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>เครื่องมือตรวจสอบข้อมูลซ้ำ - SMART Patrol</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 3px solid #28a745; margin-bottom: 25px; padding-bottom: 10px; }
        .upload-area { border: 2px dashed #28a745; padding: 40px; text-align: center; cursor: pointer; background: #e9f7ef; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; background: white; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #28a745; color: white; text-align: center; }
        .count-cell { text-align: center; font-weight: bold; color: #d9534f; font-size: 1.1em; }
        .wp-list { font-size: 0.85em; color: #555; word-break: break-all; max-width: 400px; }
        .status-cell { text-align: center; font-weight: bold; color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>เครื่องมือตรวจสอบการรายงานข้อมูลซ้ำ (SMART Patrol)</h2>
        <p>อ้างอิงคอลัมน์: A (รหัสเส้น), G (รหัสเวย์พอยท์), H (วันที่), J (X), K (Y)</p>
    </div>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <strong>คลิกเพื่ออัปโหลดไฟล์ .csv จากโปรแกรม SMART</strong>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
    </div>

    <div id="resultArea"></div>
</div>

<script>
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.readAsText(file, "TIS-620"); // รองรับภาษาไทยจากไฟล์ SMART

    reader.onload = function(event) {
        const rows = event.target.result.split(/\r?\n/).map(row => row.split(','));
        processSmartData(rows);
    };
});

function processSmartData(rows) {
    if (rows.length < 2) return;

    // 1. ดึงข้อมูลและสร้าง XY (อ้างอิงคอลัมน์ตามคู่มือ)
    let data = rows.slice(1).filter(r => r.length > 10).map(r => ({
        patrolId: r[0]?.trim(),    // คอลัมน์ A: รหัสเส้นลาดตระเวน
        waypointId: r[6]?.trim(),  // คอลัมน์ G: รหัสเวย์พอยท์
        date: r[7]?.trim(),        // คอลัมน์ H: วันที่ของเวย์พอยท์
        xy: (r[9]?.trim() || "") + (r[10]?.trim() || "") // คอลัมน์ L: ค่า XY
    }));

    // 2. เรียงลำดับตาม XY และวันที่ (เพื่อให้จุดที่พิกัดเหมือนกันมาอยู่ใกล้กัน)
    data.sort((a, b) => a.xy.localeCompare(b.xy) || a.date.localeCompare(b.date));

    // 3. วิเคราะห์หาคู่เส้นที่ซ้ำกัน
    let pairResults = {};

    for (let i = 0; i < data.length; i++) {
        let current = data[i];
        
        // เปรียบเทียบกับจุดอื่นๆ ในไฟล์ที่มีพิกัดเดียวกันแต่คนละวันที่ (Logic หน้า 10)
        for (let j = i + 1; j < data.length; j++) {
            let next = data[j];
            
            // ถ้าพิกัด (XY) ต่างกันแล้ว ให้หยุดหาในกลุ่มนี้
            if (current.xy !== next.xy) break;

            // ถ้าพิกัดเดียวกันแต่ต่างวันที่ และคนละรหัสเส้น (เงื่อนไขการซ้ำ)
            if (current.date !== next.date && current.patrolId !== next.patrolId) {
                let pairKey = [current.patrolId, next.patrolId].sort().join(", ");
                
                if (!pairResults[pairKey]) {
                    pairResults[pairKey] = { count: 0, waypoints: new Set() };
                }
                
                pairResults[pairKey].count += 1;
                if (current.waypointId) pairResults[pairKey].waypoints.add(current.waypointId);
                if (next.waypointId) pairResults[pairKey].waypoints.add(next.waypointId);
            }
        }
    }

    renderTable(pairResults);
}

function renderTable(results) {
    const area = document.getElementById('resultArea');
    let html = '<table><thead><tr>' +
               '<th>คู่เส้นลาดตระเวน (เส้นซ้ำ)</th>' +
               '<th>จำนวนจุดที่ซ้ำ (count)</th>' +
               '<th>รหัสเวย์พอยท์ที่พบการซ้ำ</th>' +
               '<th>สถานะ</th>' +
               '</tr></thead><tbody>';

    let foundData = false;
    for (const [pair, info] of Object.entries(results)) {
        // กรองเฉพาะที่ซ้ำมากกว่า 20 จุดตามเกณฑ์หน้า 14
        if (info.count >= 20) {
            const wpList = Array.from(info.waypoints).sort().join(", ");
            html += `<tr>
                <td><b>${pair}</b></td>
                <td class="count-cell">${info.count}</td>
                <td class="wp-list">${wpList}</td>
                <td class="status-cell">ต้องตรวจสอบใน SMART</td>
            </tr>`;
            foundData = true;
        }
    }

    if (!foundData) {
        html += '<tr><td colspan="4" style="text-align:center;">ไม่พบข้อมูลซ้ำที่เกินเกณฑ์ 20 จุด</td></tr>';
    }

    html += '</tbody></table>';
    area.innerHTML = html;
}
</script>

</body>
</html>
