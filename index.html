function processFullLogic(rows) {
    // ดึงข้อมูลพื้นฐาน (อ้างอิงตำแหน่งคอลัมน์จากคู่มือ)
    let data = rows.slice(1).filter(r => r.length > 10).map(r => ({
        id: r[0]?.trim(),        // คอลัมน์ A: รหัสเส้น
        waypointId: r[6]?.trim(), // คอลัมน์ G: รหัสเวย์พอยท์
        date: r[7]?.trim(),      // คอลัมน์ H: วันที่
        xy: (r[9]?.trim() || "") + (r[10]?.trim() || "") // คอลัมน์ L: ค่าพิกัดรวม
    }));

    // เรียงลำดับตามพิกัด XY และรหัสเส้น
    data.sort((a, b) => a.xy.localeCompare(b.xy) || a.id.localeCompare(b.id));

    let pairSummary = {}; // เก็บสรุปผลแยกตามคู่เส้น

    for (let i = 0; i < data.length; i++) {
        let curr = data[i];
        let next = data[i+1];
        
        // ตรรกะจับคู่เส้นที่พิกัดตรงกันแต่ต่างวัน (ตามหน้า 10 และ 12)
        if (next && curr.xy === next.xy && curr.date !== next.date) {
            let pairName = [curr.id, next.id].sort().join(" กับ ");
            
            if (!pairSummary[pairName]) {
                pairSummary[pairName] = { count: 0, waypoints: new Set() };
            }
            
            pairSummary[pairName].count += 1; // นับจำนวนจุดที่พบ
            pairSummary[pairName].waypoints.add(curr.waypointId); // เก็บรายการเวย์พอยท์
            pairSummary[pairName].waypoints.add(next.waypointId);
        }
    }

    displayFinalReport(pairSummary);
}

function displayFinalReport(pairSummary) {
    const resultDiv = document.getElementById('result');
    let html = '<h3>สรุปคู่เส้นที่พบข้อมูลซ้ำ (เกณฑ์ > 20 จุด)</h3>';
    html += '<table><tr><th>คู่เส้นที่ทับซ้อน</th><th>จำนวนจุด (count)</th><th>รหัสเวย์พอยท์ที่เกี่ยวข้อง</th><th>สถานะ</th></tr>';

    let found = false;
    for (let [pair, info] of Object.entries(pairSummary)) {
        if (info.count > 20) { // กรองเฉพาะที่ซ้ำมากกว่า 20 จุดตามคู่มือหน้า 14
            html += `<tr>
                <td>${pair}</td>
                <td style="color:red; font-weight:bold;">${info.count}</td>
                <td style="font-size: 0.8em; color: #555;">${Array.from(info.waypoints).join(", ")}</td>
                <td>ต้องตรวจสอบใน SMART</td>
            </tr>`;
            found = true;
        }
    }

    if (!found) html += '<tr><td colspan="4">ไม่พบข้อมูลซ้ำเกินเกณฑ์ที่กำหนด</td></tr>';
    html += '</table>';
    resultDiv.innerHTML = html;
}
